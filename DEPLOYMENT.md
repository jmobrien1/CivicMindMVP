# West Newbury Assistant - Deployment Guide

## ‚úÖ Development Status

**All core features are working in development:**
- ‚úì Dual-panel landing page with role selector
- ‚úì AI returns accurate West Newbury data (trash schedules, tax info, office hours, contacts)
- ‚úì Citations display correctly with inline numbers and clickable sources
- ‚úì Role switcher works in both resident and staff headers
- ‚úì Staff portal displays tickets and analytics
- ‚úì 12 structured knowledge entries seeded
- ‚úì Demo mode enabled by default

## üö´ Current Deployment Blocker

**Issue:** Deployment hangs on bundle step due to multiple port configurations in `.replit` file.

**Root Cause:** Replit Autoscale deployments only support a single external port, but your `.replit` file has 8 port configurations.

## üîß Fix Required (Manual Step)

### Step 1: Edit `.replit` File

Open `.replit` file and find the `[[ports]]` section (around lines 13-43).

**DELETE these lines:**
```toml
[[ports]]
localPort = 24678
externalPort = 3000

[[ports]]
localPort = 35189
externalPort = 5173

[[ports]]
localPort = 39339
externalPort = 3001

[[ports]]
localPort = 40507
externalPort = 6000

[[ports]]
localPort = 40973
externalPort = 4200

[[ports]]
localPort = 41679
externalPort = 3002

[[ports]]
localPort = 46829
externalPort = 3003
```

**KEEP only this:**
```toml
[[ports]]
localPort = 5000
externalPort = 80
```

### Step 2: Verify Environment Variables

Ensure these environment variables are set in your **deployment environment** (not just development):

```bash
DEMO_MODE=true
DATABASE_URL=<your production database URL>
AI_INTEGRATIONS_OPENAI_BASE_URL=<from Replit AI integration>
AI_INTEGRATIONS_OPENAI_API_KEY=<from Replit AI integration>
SESSION_SECRET=<auto-generated>
ISSUER_URL=<from Replit Auth integration>
```

**CRITICAL:** `DEMO_MODE=true` must be set in deployment environment or the dual-panel landing page won't appear.

### Step 3: Database Seeding

The demo seed runs automatically on app startup when the structured_knowledge table is empty. The seeding function:
- Checks if knowledge exists
- Seeds 12 West Newbury entries if empty
- Seeds 3 sample tickets
- Seeds 6 upcoming meetings

**No manual action needed** - seeding happens automatically when the app starts with an empty database.

### Step 4: Deploy

After fixing `.replit`:
1. Commit your changes (if needed)
2. Click "Deploy" in Replit
3. Wait for bundle step to complete (should not hang now)
4. Verify deployment boots successfully

## üß™ Testing After Deployment

Visit your deployed URL and verify:

1. **Landing Page (`/`):**
   - Shows "CivicMind ‚Äì West Newbury Demo" heading
   - DEMO badge visible
   - Two role cards: "I'm a Resident" and "I'm Town Staff"
   - Four CivicMind pillars displayed

2. **Resident Portal (`/resident`):**
   - Ask: "When is trash and recycling pickup for my house?"
   - Should return: Weekly trash, bi-weekly recycling, 6 AM curbside, holiday delays
   - Should show citations with clickable links
   - "Switch to Staff View" button visible in header

3. **Staff Portal (`/staff`):**
   - Shows metrics (Total Queries, Questions Answered, Open Tickets)
   - Shows demo tickets
   - "Switch to Resident View" button visible

## üêõ Known Issues (Non-Blocking)

- **Chat history not preserved when switching roles:** This is expected behavior. Messages are stored in component state, not persisted. This is acceptable for a demo.

## üìä What's Fixed

Since the last QA report, the following have been implemented:

1. ‚úÖ **Role switcher added to resident header** - Now matches staff portal
2. ‚úÖ **Styling consistency** - Both switchers use `outline` variant
3. ‚úÖ **All 12 knowledge entries confirmed in database**
4. ‚úÖ **Citations working correctly** - Inline [1][2][3] with Sources section
5. ‚úÖ **AI returns accurate West Newbury data** - Confirmed via E2E testing

## üéØ Next Steps

1. **Fix `.replit` file** (manual - see Step 1 above)
2. **Verify DEMO_MODE=true in deployment environment**
3. **Deploy**
4. **Test using checklist above**

Your app is ready for deployment once the `.replit` port configuration is fixed!
